# 1.4 스펙

## 0. 메타

- **요구사항 기준**: `docs/requirement/v1.4.md`
- **참조 설계**: `docs/design/final-entity-spec.md`, `docs/design/full-erd.md`
- **핵심 변화**: Company/Branch 도입, 역할별 정보(TeacherInfo/StudentInfo) 분리, 학생 자유 가입 + 반 등록 신청, 조교 직접 배정, teacher/branch 기준 ClinicSlot, 클리닉 자동 배정 + 학생 자율 변경, 학생 캘린더 통합 뷰 명세

---

## 1. 프로젝트 개요

플랫폼 목표는 학원 강사가 여러 학원·지점, 학생, 조교, 클리닉 일정을 한 화면에서 관리하도록 지원하는 것이다. 기술 아키텍처와 인증/인가 구조는 v1.2와 동일하지만, 도메인 확장에 따라 다음이 추가된다.

1. **조직 구조 계층**: Company(INDIVIDUAL/ACADEMY) → Branch → Course
2. **회원 역할별 부가 정보**: Member + StudentInfo (TeacherInfo 제거)
3. **단일 역할 시스템**: Member.role은 단일 값 (TEACHER/ASSISTANT/STUDENT/ADMIN/SUPER_ADMIN)
4. **학생 등록 파이프라인**: StudentEnrollmentRequest → 승인 시 StudentCourseEnrollment + StudentCourseRecord 자동 생성
5. **클리닉 슬롯 공유**: ClinicSlot을 teacher/branch 기준 시간표로 관리
6. **클리닉 자동 배정**: StudentCourseRecord.defaultClinicSlotId를 기반으로 Week 단위 ClinicAttendance 자동 생성
7. **학생 고정 클리닉 선택**: 학생이 초기 선택 후 변경 불가 (선생님 요청), 주차별 이동은 자유
8. **학생 캘린더**: CourseProgress, PersonalProgress, ClinicAttendance/ClinicRecord를 한 달 단위로 통합 조회

아키텍처 다이어그램은 v1.2와 동일하며 생략한다.

---

## 2. 도메인 구체화

### 2.1 주요 엔티티

| 엔티티                     | 목적/주요 필드                                                                                                                    |
| -------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| Company                    | `name`, `description`, `type (INDIVIDUAL/ACADEMY)`, `verifiedStatus (UNVERIFIED/VERIFIED)`, `creatorMemberId`, `deletedAt`        |
| Branch                     | `companyId`, `name`, `creatorMemberId`, `verifiedStatus (UNVERIFIED/VERIFIED)`, `deletedAt`                                       |
| Member                     | `email`, `password`, `name`, `phoneNumber`, `role (단일)`, `deletedAt`                                                            |
| StudentInfo                | `memberId`, `schoolName (trimmed)`, `grade (StudentGrade enum)`, `birthDate`, `parentPhone`                                       |
| TeacherBranchAssignment    | `teacherMemberId`, `branchId`, `role (OWNER/FREELANCE)`, `deletedAt`                                                              |
| TeacherAssistantAssignment | `teacherMemberId`, `assistantMemberId`, `deletedAt`                                                                               |
| Course                     | `branchId`, `teacherMemberId`, `name`, `schedules (ElementCollection)`, `deletedAt`                                               |
| StudentEnrollmentRequest   | `studentMemberId`, `courseId`, `status`, `message`, `processedByMemberId`, `processedAt`                                          |
| StudentCourseEnrollment    | `studentMemberId`, `courseId`, `enrolledAt`                                                                                       |
| StudentCourseRecord        | `studentMemberId`, `courseId`, `assistantMemberId?`, `defaultClinicSlotId`, `teacherNotes`, `deletedAt`                           |
| CourseProgress             | `course (ManyToOne, CASCADE)`, `writerId`, `date`, `title`, `content`                                                             |
| PersonalProgress           | `studentCourseRecordId`, `writerId`, `date`, `title`, `content`                                                                   |
| ClinicSlot                 | `teacherMemberId`, `creatorMemberId`, `branchId`, `dayOfWeek`, `startTime`, `endTime`, `defaultCapacity`, `deletedAt`             |
| ClinicSession              | `slotId (nullable)`, `sessionType (REGULAR/EMERGENCY)`, `creatorMemberId (nullable)`, `date`, `startTime`, `endTime`, `capacity`, `isCanceled` |
| ClinicAttendance           | `clinicSessionId`, `studentCourseRecordId`                                                                                        |
| ClinicRecord               | `clinicAttendanceId`, `writerId`, `title`, `content`, `homeworkProgress`                                                          |
| Notice                     | `teacherMemberId`, `title`, `content`                                                                                             |
| NoticeRead                 | `noticeId`, `assistantMemberId`, `readAt`                                                                                         |
| WorkLog                    | `assistantMemberId`, `date`, `startTime`, `endTime`, `hours (자동계산)`, `memo`                                                   |
| Feedback                   | `memberId`, `content`, `status (SUBMITTED/RESOLVED)`                                                                              |

### 2.2 관계 및 규칙

#### 2.2.1 엔티티 관계

- **조직**: Company 1:N Branch, Branch 1:N Course
- **회원**: Member ↔ StudentInfo (1:1), Member.role은 단일 값
- **배정**: Teacher ↔ Branch (TeacherBranchAssignment, M:N), Teacher ↔ Assistant (TeacherAssistantAssignment, M:N), Student ↔ Course (StudentCourseEnrollment, M:N)
- **담당 조교**: Assistant 1:N StudentCourseRecord (조교가 담당 학생을 관리)
- **진도**: Course 1:N CourseProgress (CASCADE), StudentCourseRecord 1:N PersonalProgress
- **클리닉**: Course ↔ ClinicSlot (teacher/branch 논리 연결), ClinicSlot 1:N ClinicSession, ClinicSession 1:N ClinicAttendance, ClinicAttendance 1:1 ClinicRecord
- **공지**: Member(TEACHER) 1:N Notice, Notice 1:N NoticeRead
- **근무**: Member(ASSISTANT) 1:N WorkLog

#### 2.2.2 제약 조건

- StudentCourseRecord: `(studentMemberId, courseId)` Unique
- StudentCourseEnrollment: `(studentMemberId, courseId)` Unique
- ClinicSession: REGULAR는 `(slotId, date)` Unique (EMERGENCY는 slotId 없음)
- ClinicAttendance: `(clinicSessionId, studentCourseRecordId)` Unique
- ClinicRecord: `clinicAttendanceId` Unique (1:1 관계)
- NoticeRead: `(noticeId, assistantMemberId)` Unique
- WorkLog: `(assistantMemberId, date)` Unique
- TeacherAssistantAssignment: `(teacherMemberId, assistantMemberId)` Unique

#### 2.2.3 비즈니스 규칙

- **Company/Branch 검증**:
  - INDIVIDUAL Company는 Teacher가 직접 입력하면 Company/Branch 모두 `verifiedStatus=VERIFIED`로 저장되고 Branch는 1개만 허용된다.
  - ACADEMY Company는 기본적으로 SuperAdmin이 VERIFIED 상태로 사전 등록하지만, Teacher가 직접 입력한 경우 `verifiedStatus=UNVERIFIED`로 생성되어 해당 Teacher만 사용할 수 있다. SuperAdmin이 검증하면 Company/Branch의 verifiedStatus를 VERIFIED로 바꿔 전역 공개된다.
- **Course 공개 조건**: `Course.deletedAt IS NULL` AND `Branch.deletedAt IS NULL` AND `Branch.verifiedStatus=VERIFIED` AND `Company.verifiedStatus=VERIFIED` AND `Company.deletedAt IS NULL`
- **Soft Delete**: Company, Branch, Member, TeacherBranchAssignment, TeacherAssistantAssignment, Course, StudentCourseRecord, ClinicSlot은 `deletedAt` 타임스탬프로 삭제 관리. `deletedAt IS NULL` 조건으로 활성 데이터만 조회
- **TeacherAssistantAssignment**: Teacher가 Assistant 이메일로 검색 후 직접 생성, Soft delete로 활성/비활성 관리
- **StudentEnrollmentRequest**: Teacher 또는 Assistant가 승인/거절, 처리 시 `processedByMemberId` 기록
- **승인 시 자동 생성**: StudentCourseEnrollment + StudentCourseRecord
- **ClinicSlot 공유 규칙**: teacher/branch 기준으로 슬롯 목록을 공유, creatorMemberId로 생성자 추적
- **defaultClinicSlotId 검증**: slot.teacherMemberId/branchId가 course와 동일해야 하며, 동일 슬롯 중복 선택 및 시간 겹침은 불가
- **ClinicSession 타입**: REGULAR (slotId 기반 자동 생성), EMERGENCY (수동 생성, slotId=null, 시간 직접 입력)

### 2.3 주요 플로우

#### 2.3.1 Teacher/Assistant 승인 플로우

1. 학생이 공개 Course에 등록 신청 생성
2. 담당 Course의 Teacher 또는 매핑된 Assistant가 요청 목록 조회
3. 승인 시:
   - `StudentCourseEnrollment` insert (`enrolledAt=now`)
   - `StudentCourseRecord` insert (`defaultClinicSlotId` 초기값은 teacher/branch 슬롯 중 Teacher가 설정하거나 Null)
   - `StudentEnrollmentRequest.status=APPROVED`, `processedByMemberId`=승인자, `processedAt=now`

- 승인 후 Teacher는 StudentCourseRecord에 담당 조교(`assistantMemberId`)를 지정할 수 있으며, TeacherAssistantAssignment로 연결된 조교만 선택 가능하고 필요 시 언제든 재배정/해제할 수 있다.
  - 프론트엔드는 요청 목록을 체크박스로 선택한 뒤 승인/거절 API를 선택된 각각의 요청 ID에 대해 호출한다(전체 선택/해제 포함). 서버는 단건 엔드포인트만 유지한다.

4. 거절 시 status=REJECTED, optional message

#### 2.3.2 클리닉 자동 배정 & 변경

**1. 고정 클리닉 슬롯 선택 (Student)**

- 반 등록 승인 후 Course의 teacher/branch 기준 ClinicSlot 목록 조회
- 학생이 Course별 고정 클리닉 슬롯 선택 (defaultClinicSlotId 설정)
- 동일 슬롯 중복 선택 및 시간 겹침은 허용하지 않음
- 선택 후 학생이 직접 변경 불가 (악용 방지)
- 변경 필요 시 선생님에게 요청 → 선생님이 StudentCourseRecord.defaultClinicSlotId 수정

**2. 주차별 세션 자동 생성 (REGULAR 타입)**

- 매주 일요일 자정에 해당 주차(월~일) ClinicSession 자동 생성
- sessionType = REGULAR, slotId 설정, startTime/endTime/ capacity = ClinicSlot 값 복사
- 활성 ClinicSlot에 대해 defaultClinicSlotId를 가진 모든 StudentCourseRecord에 대해 ClinicAttendance 자동 생성
- 생성 순서:
  1) 주차별 ClinicSession 생성
  2) defaultClinicSlotId로 이번 주 세션을 찾은 뒤 `clinicSessionId + studentCourseRecordId`로 Attendance 생성
- 학생이 주중에 defaultClinicSlotId를 새로 설정/변경하면 같은 주에 이미 생성된 ClinicSession 중 아직 시작 전인 세션에 대해서도 즉시 ClinicAttendance를 생성해 공백을 방지한다.

**3. 긴급 세션 수동 생성 (EMERGENCY 타입)**

- Teacher 또는 Assistant가 즉시 ClinicSession 생성
- sessionType = EMERGENCY, slotId = null, creatorMemberId 기록
- date, startTime, endTime, capacity는 생성 시 직접 지정
- ClinicAttendance는 수동으로 추가 (자동 생성 없음)

**4. 학생의 유연한 일정 조정**

- 세션 시작 30분 전까지 같은 주(월~일) 내 다른 날짜로 이동 가능
- 횟수 제한 없음 (같은 주 내에서만)
- 변경 시 기존 Attendance 삭제 → 새로운 Session에 Attendance 생성
- 변경 이벤트는 auditing 필드로 기록

**5. 추가 클리닉 참석 신청**

- 승인 없이 바로 참석 신청 가능
- 횟수 제한 없음 (최소 주1회 보장)

**6. 출석명단 확정**

- 세션 시작 10분 전에 ClinicAttendance 목록 확정
- 선생님/조교에게 출석명단 제공
- 세션 시작 이후 변경 API는 409 반환

#### 2.3.3 학생 캘린더

- Teacher/Assistant는 `/students/{studentId}/calendar?year=YYYY&month=MM`를 호출해 특정 학생의 월간 일정을 조회한다. 호출자는 Course.teacherMemberId이거나 해당 Course에 연결된 TeacherAssistantAssignment가 있어야 한다.
- 학생은 직접 캘린더를 조회하지 않으며, Teacher/Assistant가 조회한 결과를 안내한다.
- Aggregation 대상
  - CourseProgress: Course 단위 공통 진도를 날짜순으로 합친다. Course 삭제 시 CASCADE 되므로 고아 데이터가 없다.
  - PersonalProgress: StudentCourseRecord 단위 개별 진도이며, writerId/role을 함께 내려준다.
  - ClinicEvents: ClinicSession + ClinicAttendance + ClinicRecord를 조인한다. Session의 `isCanceled`, Attendance 존재 여부, Record 유무를 기반으로 상태를 도출한다.
- 응답 예시는 다음과 같다.

```jsonc
{
  "studentId": "uuid",
  "year": 2025,
  "month": 3,
  "courseProgress": [
    {
      "id": "uuid",
      "courseId": "uuid",
      "courseName": "중3 수학 A",
      "date": "2025-03-02",
      "title": "3월 1주차",
      "writerId": "uuid",
      "writerRole": "TEACHER",
    },
  ],
  "personalProgress": [
    {
      "id": "uuid",
      "studentCourseRecordId": "uuid",
      "courseId": "uuid",
      "courseName": "중3 수학 A",
      "date": "2025-03-03",
      "title": "약점 보완",
      "writerRole": "ASSISTANT",
    },
  ],
  "clinicEvents": [
    {
      "clinicSessionId": "uuid",
      "clinicAttendanceId": "uuid",
      "courseId": "uuid",
      "slotId": "uuid",
      "date": "2025-03-04",
      "startTime": "18:00",
      "endTime": "19:00",
      "isCanceled": false,
      "record": {
        "id": "uuid",
        "title": "수학 클리닉 3/4",
        "writerRole": "TEACHER",
      },
    },
  ],
}
```

- StudentCalendarQueryService는 현재 캐시 없이 DB를 직접 조회해 응답을 생성한다. Redis 캐싱은 향후 최적화 단계에서 도입한다.
- 응답 필드명은 `courseProgress`, `personalProgress`를 사용한다.

#### 2.3.4 출강 등록 & 검증 전략

1. Teacher는 “학원 관리”에서 INDIVIDUAL(개인 학원) 또는 ACADEMY(회사 학원)를 선택해 출강 학원을 등록한다.
2. **개인 학원(INDIVIDUAL)**
   - `company.name`을 입력하면 시스템이 Company와 Branch를 동시에 생성한다. 두 엔티티 모두 `verifiedStatus=VERIFIED`로 저장되고 Branch는 1개만 허용된다.
   - 생성한 Teacher에게 `TeacherBranchAssignment(role=OWNER)`가 자동 연결되며 즉시 Course를 만들 수 있다.
3. **회사 학원(ACADEMY)**
   - Verified Company/Branch 목록이 존재하면 해당 항목을 선택하고, 새 Course를 생성할 때 `TeacherBranchAssignment(role=FREELANCE)`가 자동으로 부여된다.
   - 회사가 없으면 “직접 입력”을 선택해 Company + Branch 정보를 입력한다. 두 엔티티 모두 `verifiedStatus=UNVERIFIED`로 생성되며, Assignment는 FREELANCE로 생성된다.
   - 회사는 있지만 지점이 없으면 회사를 선택한 뒤 Branch 정보를 직접 입력한다. Company는 VERIFIED를 유지하지만 새 Branch는 UNVERIFIED로 기록되고 Assignment는 FREELANCE로 생성된다.
   - UNVERIFIED Company/Branch는 생성자만 조회/사용할 수 있다.
4. SuperAdmin은 `GET /companies?verifiedStatus=UNVERIFIED` / `GET /branches?verifiedStatus=UNVERIFIED`로 대기 목록을 조회한 뒤, 서류 검증 후 `PATCH /companies/{id}/verified-status` 또는 Branch 전용 API로 VERIFIED로 전환한다(필요 시 `isActive=false` 처리). VERIFIED된 엔티티는 `/public/courses` 및 다른 Teacher 검색에 노출된다.
5. Company/Branch의 verifiedStatus 변경 이력은 auditing 필드로 추적한다.

---

## 3. API 리소스 개요

| 리소스                    | Base Path                                            | 기능 요약                                                             |
| ------------------------- | ---------------------------------------------------- | --------------------------------------------------------------------- |
| Auth                      | /auth                                                | 로그인, 토큰 재발급, 역할별 회원가입, 초대 코드 검증                  |
| Members                   | /members                                             | 내 정보 조회/수정, 역할 필터 조회                                     |
| StudentInfos              | /students/me/info                                    | 학생 부가 정보 CRUD (가입 시 필수)                                    |
| Companies                 | /companies                                           | Company 등록/조회, SuperAdmin 검증                                    |
| Branches                  | /branches                                            | Branch CRUD (OWNER 전용 생성/수정)                                    |
| Courses                   | /courses, /public/courses                            | Course 관리 + Branch/Company 기반 공개 검색                           |
| StudentEnrollmentRequests | /student-enrollment-requests                         | 학생 신청 생성/조회/승인/거절                                         |
| StudentCourses            | /student-courses, /students/me/courses               | Enrollment/Record 조회, teacherNotes/defaultClinicSlot/담당 조교 수정 |
| CourseProgress            | /course-progress                                     | 반 공통 진도 CRUD                                                     |
| PersonalProgress          | /personal-progress                                   | 학생 개별 진도 CRUD                                                   |
| ClinicSlots               | /clinic-slots                                        | teacher/branch 클리닉 슬롯 CRUD                                       |
| ClinicSessions            | /clinic-sessions                                     | 세션 조회/취소/수동 생성                                              |
| ClinicAttendances         | /clinic-attendances, /students/me/clinic-attendances | 출석 조회, 학생 자율 이동 API                                         |
| ClinicRecords             | /clinic-records                                      | 출석 기록 CRUD                                                        |
| StudentCalendar           | /students/{id}/calendar                              | Teacher/Assistant 전용 월간 통합 진도/클리닉 뷰                       |
| Notices / NoticeReads     | /notices, /notices/{id}/reads                        | 조교 공지 및 읽음 처리                                                |
| WorkLogs                  | /work-logs                                           | 조교 근무일지 CRUD                                                    |
| Feedback                  | /feedback                                            | 사용자 피드백 제출/상태 변경                                          |

---

## 4. 리소스 상세

> **SuperAdmin 기본 권한**  
> 모든 API는 표에 명시된 역할이 기본 접근 대상이지만, SuperAdmin은 감사/긴급 조치 목적으로 전체 리소스에 접근할 수 있다. 테이블에 SuperAdmin이 별도로 기재되지 않은 경우에도 예외적으로 허용된다.

### 4.1 Companies

| Method | URI                                    | Description                                                                                                                  | Role                 |
| ------ | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | -------------------- |
| POST   | /companies                             | Company 등록 (type, name, description). INDIVIDUAL은 `verifiedStatus=VERIFIED` + Branch 자동 생성, ACADEMY는 기본 UNVERIFIED | TEACHER              |
| GET    | /companies?verifiedStatus&type&keyword | 검증 상태/타입/키워드 기반 검색. Teacher는 VERIFIED만 조회, SuperAdmin은 전체                                                | TEACHER, SUPER_ADMIN |
| PATCH  | /companies/{companyId}/verified-status | SuperAdmin이 verifiedStatus 전환 및 필요 시 soft delete (deletedAt 설정)                                                     | SUPER_ADMIN          |

- Company가 `deletedAt IS NOT NULL`이면 Branch/Course/공개 검색에서도 숨김 처리된다.
- INDIVIDUAL Company 등록 시 Branch도 함께 생성되며, 생성 Teacher에게 OWNER Assignment가 설정된다.
- ACADEMY Company는 SuperAdmin이 VERIFIED로 생성하거나 Teacher가 UNVERIFIED로 등록한 뒤 검증을 기다린다.

### 4.2 Branches

| Method | URI                  | Description                                                                                                                                                   | Role               |
| ------ | -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------ |
| POST   | /branches            | Teacher가 선택한 Company 하위에 Branch를 입력. INDIVIDUAL은 Company 생성 시 자동 처리, ACADEMY 직접 입력 시 `verifiedStatus=UNVERIFIED`, Assignment=FREELANCE | TEACHER            |
| GET    | /branches?companyId  | 특정 Company의 활성 Branch 목록 조회 (`verifiedStatus=VERIFIED`, `deletedAt IS NULL`가 기본)                                                                  | TEACHER, ASSISTANT |
| PATCH  | /branches/{branchId} | OWNER(INDIVIDUAL) 또는 SuperAdmin이 이름 수정/soft delete (deletedAt 설정). ACADEMY UNVERIFIED Branch는 검증 전까지 읽기 전용                                 | TEACHER            |

- FREELANCE Teacher는 Branch를 조회만 가능하며 수정 권한이 없다.
- Branch soft delete 시 해당 Branch의 Course도 조회 목록에서 제외된다.
- Branch에는 `creatorMemberId`, `verifiedStatus`, `deletedAt`이 기록되어 SuperAdmin이 검증 여부를 판단한다.

### 4.3 Courses

- **공개 검색**: `GET /public/courses?keyword&companyId&branchId&teacherId&page`
  - 필터 조건: `Course.deletedAt IS NULL` AND `Branch.deletedAt IS NULL` AND `Branch.verifiedStatus=VERIFIED` AND `Company.verifiedStatus=VERIFIED` AND `Company.deletedAt IS NULL`
  - 정렬: 최신 생성순 → 이름순

| Method | URI                 | Description                                                                           | Role               |
| ------ | ------------------- | ------------------------------------------------------------------------------------- | ------------------ |
| POST   | /courses            | Teacher가 Branch 하위에 Course 생성, TeacherBranchAssignment 없으면 FREELANCE로 생성. | TEACHER            |
| GET    | /courses            | Teacher/Assistant 관점의 Course 목록 및 기본 스케줄 조회.                             | TEACHER, ASSISTANT |
| GET    | /courses/{courseId} | Course 상세 (학생 목록, 스케줄, 클리닉 슬롯)                                          | TEACHER, ASSISTANT |
| PATCH  | /courses/{courseId} | 이름, 스케줄 수정                                                                     | TEACHER            |
| DELETE | /courses/{courseId} | Soft delete (deletedAt 설정)                                                          | TEACHER            |

### 4.4 StudentEnrollmentRequests

| Method | URI                                            | Description                                      | Role               |
| ------ | ---------------------------------------------- | ------------------------------------------------ | ------------------ |
| POST   | /student-enrollment-requests                   | 학생이 `courseId`, `message`로 신청 생성         | STUDENT            |
| GET    | /student-enrollment-requㅏests?courseId&status | Teacher/Assistant가 Course별 대기/처리 내역 조회 | TEACHER, ASSISTANT |
| PATCH  | /student-enrollment-requests/{id}/approve      | 승인 처리 → Enrollment/Record 자동 생성          | TEACHER, ASSISTANT |
| PATCH  | /student-enrollment-requests/{id}/reject       | 거절 처리 (`message` optional)                   | TEACHER, ASSISTANT |

- 승인/거절 시 `processedByMemberId`, `processedAt`을 기록한다.
- 승인 시 `StudentCourseEnrollment.enrolledAt`과 `StudentCourseRecord`가 동시에 생성되며, defaultClinicSlotId는 teacher/branch 슬롯 중 Teacher가 후속 설정한다.

### 4.5 StudentCourses & Records

| Method | URI                               | Description                                                               | Role               |
| ------ | --------------------------------- | ------------------------------------------------------------------------- | ------------------ |
| GET    | /student-courses?courseId         | Course별 StudentCourseEnrollment + StudentCourseRecord 조합 리스트        | TEACHER, ASSISTANT |
| GET    | /students/me/courses              | 학생 본인의 승인된 Course 목록                                            | STUDENT            |
| PATCH  | /student-courses/{recordId}/notes | Teacher가 `teacherNotes`, `defaultClinicSlotId`, `assistantMemberId` 수정 | TEACHER            |
| GET    | /student-courses/{recordId}       | 특정 학생 기록 상세                                                       | TEACHER, ASSISTANT |
| DELETE | /student-courses/{recordId}       | StudentCourseRecord soft delete (학생 휴학/퇴소)                          | TEACHER            |

- `defaultClinicSlotId` 수정 시 teacher/branch 일치 여부와 중복/시간 겹침을 검증한다.
- 검증 후 이후 생성되는 ClinicSession부터 새로운 슬롯으로 Attendance가 생성된다.
- `assistantMemberId`는 TeacherAssistantAssignment 기준으로 검증되며, null로 설정하면 담당 조교를 해제한다. 지정된 조교는 해당 학생의 PersonalLesson/ClinicRecord 작성 권한을 우선 부여받는다.
- `deletedAt IS NOT NULL`인 Record는 학생 휴학/퇴소를 의미하며, PersonalLesson/ClinicAttendance 생성이 중지된다.

### 4.6 StudentInfos

| Method | URI                        | Description                                                  | Role               |
| ------ | -------------------------- | ------------------------------------------------------------ | ------------------ |
| GET    | /students/me/info          | 학생 본인의 부가 정보 조회                                   | STUDENT            |
| PUT    | /students/me/info          | 학교/학년/생년월일/보호자 연락처 수정 (idempotent)           | STUDENT            |
| GET    | /students/{studentId}/info | Course 관계가 있는 Teacher/Assistant가 학생 부가 정보를 조회 | TEACHER, ASSISTANT |

- grade는 `StudentGrade` Enum(ELEMENTARY_1~6, MIDDLE_1~3, HIGH_1~3, GAP_YEAR) 중 하나만 허용되며, UI에서 드롭다운으로 선택하도록 강제한다.
- schoolName은 자유 입력 문자열이지만 저장 시 Trim/중복 공백 제거를 수행하고, 자동완성/검색을 통해 표준 표기를 유도한다.
- 회원가입 시 StudentInfo가 자동 생성되며 필수 필드 누락 시 가입이 거절된다.
- Teacher/Assistant 조회 권한은 StudentCourseRecord 관계를 기반으로 제한된다.

### 4.7 Progress (Course & Personal)

#### CourseProgress

| Method | URI                             | Description             | Role                                       |
| ------ | ------------------------------- | ----------------------- | ------------------------------------------ |
| POST   | /course-progress                | Course 공통 진도 작성   | TEACHER                                    |
| GET    | /course-progress?courseId&month | Course별 진도 목록 조회 | TEACHER, ASSISTANT, STUDENT(승인된 Course) |
| PATCH  | /course-progress/{id}           | 제목/본문 수정          | TEACHER                                    |
| DELETE | /course-progress/{id}           | 진도 삭제 (실제 DELETE) | TEACHER                                    |

#### PersonalProgress

| Method | URI                                      | Description                          | Role                              |
| ------ | ---------------------------------------- | ------------------------------------ | --------------------------------- |
| POST   | /personal-progress                       | StudentCourseRecord별 개별 진도 작성 | TEACHER, ASSISTANT                |
| GET    | /personal-progress?studentCourseRecordId | 학생 개별 진도 조회                  | TEACHER, ASSISTANT, STUDENT(본인) |
| PATCH  | /personal-progress/{id}                  | 내용 수정                            | TEACHER, ASSISTANT                |
| DELETE | /personal-progress/{id}                  | 개별 진도 삭제                       | TEACHER, ASSISTANT                |

- PersonalProgress는 StudentCourseRecord가 비활성화되면 더 이상 작성할 수 없다.
- 두 리소스 모두 StudentCalendar(섹션 2.3.3) 집계 대상이다.

### 4.8 Clinic 도메인

#### 4.8.1 ClinicSlots

| Method | URI                    | Description                                                                                                 | Role                                     |
| ------ | ---------------------- | ----------------------------------------------------------------------------------------------------------- | ---------------------------------------- |
| POST   | /clinic-slots          | Teacher/Branch 기준 Slot 생성 (`branchId`, `dayOfWeek`, `startTime`, `defaultCapacity`), creatorMemberId 자동 기록 | TEACHER                                  |
| GET    | /clinic-slots?courseId | Course의 teacher/branch 기준 클리닉 슬롯 목록 조회                                                          | TEACHER, ASSISTANT, STUDENT(본인 Course) |
| PATCH  | /clinic-slots/{slotId} | 시간/정원 변경                                                                                              | TEACHER                                  |
| DELETE | /clinic-slots/{slotId} | Soft delete (deletedAt 설정)                                                                                | TEACHER                                  |

- Slot은 teacher/branch 기준 시간표이며, 동일 Course들에서 동일 슬롯 목록을 조회한다.
- soft delete 시 해당 Slot 기반 Session 생성이 중지된다.
- creatorMemberId로 누가 해당 슬롯을 생성했는지 추적한다.

#### 4.8.2 ClinicSessions

| Method | URI                                  | Description                                                                                   | Role               |
| ------ | ------------------------------------ | --------------------------------------------------------------------------------------------- | ------------------ |
| GET    | /clinic-sessions?dateRange&teacherId | 요일/Teacher 필터 기반 세션 조회                                                              | TEACHER, ASSISTANT |
| POST   | /clinic-slots/{slotId}/sessions      | 정규 세션 수동 생성 (sessionType=REGULAR, slotId 설정, startTime/endTime/ capacity=slot 값)  | TEACHER            |
| POST   | /clinic-sessions/emergency           | 긴급 세션 생성 (sessionType=EMERGENCY, slotId=null, date/startTime/endTime, creatorMemberId 기록, capacity 직접 지정) | TEACHER, ASSISTANT |
| PATCH  | /clinic-sessions/{sessionId}/cancel  | `isCanceled=true` 표기                                                                        | TEACHER            |

- 시스템 배치가 매주 일요일 자정에 활성 Slot을 순회하며 주간 REGULAR Session을 자동 생성한다 (capacity = defaultCapacity).
- EMERGENCY Session은 Teacher/Assistant가 날짜/시간을 지정해 수동 생성하며, slotId 없이 독립적으로 운영된다.
- Session 취소 시 연관 Attendance는 유지되지만 StudentCalendar에서 CANCELED로 표시된다.

#### 4.8.3 ClinicAttendances & 학생 자율 이동

| Method | URI                                      | Description                                                     | Role               |
| ------ | ---------------------------------------- | --------------------------------------------------------------- | ------------------ |
| GET    | /clinic-attendances?clinicSessionId      | 특정 세션 출석 명단                                             | TEACHER, ASSISTANT |
| POST   | /clinic-sessions/{sessionId}/attendances | Teacher/Assistant가 추가 참석자를 등록                          | TEACHER, ASSISTANT |
| DELETE | /clinic-attendances/{attendanceId}       | Teacher/Assistant가 수동 삭제                                   | TEACHER, ASSISTANT |
| PATCH  | /students/me/clinic-attendances          | `{ "fromSessionId": UUID, "toSessionId": UUID }` 동일 주차 이동 | STUDENT            |

- 주간 자동 생성은 teacher/branch 슬롯 기준으로 StudentCourseRecord.defaultClinicSlotId를 참조해 기본 Attendance를 만든다. defaultClinicSlotId가 없으면 자동 배정되지 않는다.
- 생성 순서: 해당 주차 ClinicSession 생성 → defaultClinicSlotId로 매칭 → Attendance 생성.
- 학생 이동 제약: 세션 시작 30분 전까지, 동일 Course, 동일 주차.
- 이동 성공 시 기존 Attendance 삭제, 신규 Attendance 생성, auditable 필드에 변경자(학생)을 기록한다.

#### 4.8.4 ClinicRecords

| Method | URI                                | Description                | Role                                         |
| ------ | ---------------------------------- | -------------------------- | -------------------------------------------- |
| POST   | /clinic-records                    | Attendance별 1:1 기록 작성 | TEACHER, ASSISTANT                           |
| GET    | /clinic-records?clinicAttendanceId | 기록 조회                  | TEACHER, ASSISTANT, STUDENT(본인 Attendance) |
| PATCH  | /clinic-records/{id}               | 제목/내용/진도 수정        | TEACHER, ASSISTANT                           |
| DELETE | /clinic-records/{id}               | 기록 삭제                  | TEACHER, ASSISTANT                           |

- ClinicRecord 작성 시 Attendance 상태가 COMPLETED로 간주되며 StudentCalendar에서 `record` 필드가 채워진다.

### 4.9 Student Calendar

- `GET /students/{studentId}/calendar?year&month`는 Teacher/Assistant 전용이며 ISO-8601 날짜 파라미터를 사용한다.
- 응답 구조는 섹션 2.3.3의 JSON 예시를 따른다.
- 현재 버전은 Redis 캐싱 없이 CourseProgress/PersonalProgress/ClinicEvents를 DB에서 조회해 날짜 오름차순으로 정렬하여 반환한다.
- 접근 제어: Teacher/Assistant는 Course 관계가 있어야 하며, SuperAdmin은 감사 목적으로 전부 접근할 수 있다.

### 4.10 Notices, WorkLogs, Feedback

#### Notices & NoticeReads

| Method | URI                       | Description                                                        | Role               |
| ------ | ------------------------- | ------------------------------------------------------------------ | ------------------ |
| POST   | /notices                  | 조교 공지 작성                                                     | TEACHER            |
| GET    | /notices                  | Teacher는 본인 공지 목록, Assistant는 연결된 Teacher의 공지를 조회 | TEACHER, ASSISTANT |
| POST   | /notices/{noticeId}/reads | Notice 읽음 처리 (`readAt=now`)                                    | ASSISTANT          |
| DELETE | /notices/{noticeId}       | 공지 삭제                                                          | TEACHER            |

#### WorkLogs

| Method | URI                              | Description                                   | Role               |
| ------ | -------------------------------- | --------------------------------------------- | ------------------ |
| POST   | /work-logs                       | 근무일지 작성 (`hours`는 start/end 기반 계산) | ASSISTANT          |
| GET    | /work-logs?assistantId&dateRange | 조교/Teacher가 근무일지를 조회                | ASSISTANT, TEACHER |
| PATCH  | /work-logs/{id}                  | 근무일지 수정                                 | ASSISTANT          |
| DELETE | /work-logs/{id}                  | 근무일지 삭제                                 | ASSISTANT          |

#### Feedback

| Method | URI                    | Description                      | Role                        |
| ------ | ---------------------- | -------------------------------- | --------------------------- |
| POST   | /feedback              | 피드백 제출 (`status=SUBMITTED`) | TEACHER, ASSISTANT, STUDENT |
| GET    | /feedback              | SuperAdmin이 전체 피드백 조회    | SUPER_ADMIN                 |
| PATCH  | /feedback/{id}/resolve | `status=RESOLVED`로 처리         | SUPER_ADMIN                 |

---

## 5. 비기능 및 통합

- **보안**: Spring Security + JWT로 인증/인가를 수행한다. 모든 API는 Role 기반 접근 제어를 강제한다.
- **성능**: 평균 응답 1초 이하 목표. StudentCalendar 월간 뷰는 현재 DB 조회 + 정렬로 제공하며, 향후 Redis 캐시 도입으로 반복 조회를 최적화한다. Course/Clinic 목록은 필터링 인덱스(섹션 2와 design spec 참조)를 사용한다.
- **확장/가용성**: Docker Compose → AWS EC2 배포, GitHub Actions CI/CD를 유지한다. 서비스 노드 장애 시 5분 내 롤링 재배포를 목표로 한다.
- **자동화**: 매주 일요일 자정 배치가 ClinicSession/Attendance를 생성하며, Feedback 정리 작업도 동일 배치에서 수행한다. 학생 자율 변경 API는 동기 REST로 처리 후 관련 캐시(StudentCalendar)를 무효화한다.
- **관측/감사**: 모든 엔티티는 BaseEntity auditing을 사용하며, ResponseAspect + RsData 규약으로 상태 코드를 통일한다. 주요 이벤트(Company/Branch verifiedStatus 변경, TeacherAssistantAssignment 생성/비활성화)는 별도 감사 로그에 기록한다.
- **진도 관리**: CourseProgress/PersonalProgress로 네이밍 통일 (SharedLesson/PersonalLesson 대체)

---

## 6. 추적성

- **FR-01 (조직 관리)**: 섹션 2.1, 2.3.4, 4.1~4.3이 Company/Branch/Course 구조와 SuperAdmin 검증 절차를 정의한다.
- **FR-02 (학생 등록)**: 섹션 2.3.1과 4.4~4.6이 StudentEnrollmentRequest → StudentCourseEnrollment/Record, StudentInfo 흐름을 구체화한다.
- **FR-03 (클리닉)**: 섹션 2.3.2, 4.8이 ClinicSlot/Session/Attendance/Record 전체 라이프사이클과 학생 자율 이동을 다룬다.
- **FR-04 (조교 협업)**: 섹션 2.2.3, 4.10이 TeacherAssistantAssignment, Notice, WorkLog를 묶어 Teacher-Assistant 협업 요구사항을 충족한다.
- **FR-05 (학생 캘린더)**: 섹션 2.3.3과 4.9가 CourseProgress/PersonalProgress/Clinic 데이터를 통합하는 월간 뷰를 명시한다.

Requirement v1.4와 design docs(`docs/design/final-entity-spec.md`, `docs/design/full-erd.md`)를 이 스펙이 모두 참조하므로 TODO/PLAN 작성 시 본 문서를 최신 기준으로 사용한다.
