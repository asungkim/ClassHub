# 1.3 스펙

## 0. 메타
- **요구사항 기준**: `docs/requirement/v1.3.md`
- **참조 설계**: `docs/design/final-entity-spec.md`, `docs/design/full-erd.md`
- **핵심 변화**: Company/Branch 도입, 역할별 정보(TeacherInfo/StudentInfo) 분리, 학생 자유 가입 + 반 등록 신청, 조교 초대 단일 사용, 클리닉 자동 배정 + 학생 자율 변경, 학생 캘린더 통합 뷰 명세

---

## 1. 프로젝트 개요

플랫폼 목표는 학원 강사가 여러 학원·지점, 학생, 조교, 클리닉 일정을 한 화면에서 관리하도록 지원하는 것이다. 기술 아키텍처와 인증/인가 구조는 v1.2와 동일하지만, 도메인 확장에 따라 다음이 추가된다.

1. **조직 구조 계층**: Company(INDIVIDUAL/ACADEMY) → Branch → Course
2. **회원 역할별 부가 정보**: Member + TeacherInfo + StudentInfo
3. **학생 등록 파이프라인**: StudentEnrollmentRequest → 승인 시 StudentCourseEnrollment + StudentCourseRecord 자동 생성
4. **클리닉 자동 배정**: StudentCourseRecord.defaultClinicSlotId를 기반으로 Week 단위 ClinicAttendance 자동 생성, 학생이 주 단위로 변경 가능
5. **학생 캘린더**: SharedLesson, PersonalLesson, ClinicAttendance/ClinicRecord를 한 달 단위로 통합 조회

아키텍처 다이어그램은 v1.2와 동일하며 생략한다.

---

## 2. 도메인 구체화

### 2.1 주요 엔티티

| 엔티티 | 목적/주요 필드 |
| --- | --- |
| Company | `name`, `description`, `type (INDIVIDUAL/ACADEMY)`, `status (UNVERIFIED/VERIFIED/REJECTED)`, `isActive` |
| Branch | `companyId`, `name`, `isActive` |
| Member | `email`, `password`, `name`, `phoneNumber`, `roles (ElementCollection)`, `isActive` |
| TeacherInfo | `memberId`, `subjects` |
| StudentInfo | `memberId`, `schoolName`, `grade`, `birthDate`, `parentPhone` |
| TeacherBranchAssignment | `teacherMemberId`, `branchId`, `role (OWNER/MANAGER/EMPLOYEE/FREELANCE)`, `isActive` |
| TeacherAssistantAssignment | `teacherMemberId`, `assistantMemberId`, `isActive` |
| Course | `branchId`, `teacherMemberId`, `name`, `schedules (ElementCollection)`, `isActive` |
| StudentEnrollmentRequest | `studentMemberId`, `courseId`, `status`, `message`, `processedByMemberId`, `processedAt` |
| StudentCourseEnrollment | `studentMemberId`, `courseId`, `enrolledAt` |
| StudentCourseRecord | `studentMemberId`, `courseId`, `defaultClinicSlotId`, `teacherNotes`, `isActive` |
| SharedLesson | `courseId`, `writerId`, `date`, `title`, `content` |
| PersonalLesson | `studentCourseRecordId`, `writerId`, `date`, `title`, `content` |
| ClinicSlot | `teacherMemberId`, `branchId`, `dayOfWeek`, `startTime`, `endTime`, `capacity`, `isActive` |
| ClinicSession | `slotId`, `date`, `isCanceled` |
| ClinicAttendance | `clinicSessionId`, `studentCourseRecordId` |
| ClinicRecord | `clinicAttendanceId`, `writerId`, `title`, `content`, `homeworkProgress` |
| Invitation | `senderId (Teacher)`, `targetEmail`, `code`, `status`, `expiredAt`, `useCount`, `maxUses=1` |
| WorkLog | `assistantMemberId`, `date`, `startTime`, `endTime`, `hours`, `memo` |
| Feedback | `memberId`, `content`, `status` |

### 2.2 관계 및 규칙

- Company 1:N Branch, Branch 1:N Course, Course 1:N SharedLesson
- Member ↔ TeacherInfo, Member ↔ StudentInfo 각각 1:1
- Teacher ↔ Branch (TeacherBranchAssignment), Teacher ↔ Assistant (TeacherAssistantAssignment), Student ↔ Course (StudentCourseEnrollment)는 모두 M:N
- StudentCourseRecord는 `(studentMemberId, courseId)` Unique, PersonalLesson/ClinicAttendance/ClinicRecord는 이 Record를 FK로 사용
- Invitation은 **email 기반 단일 사용**: `targetEmail` 필수, `maxUses=1`, 사용 시 자동으로 TeacherAssistantAssignment 생성
- Course 공개 조건: `Branch.isActive=true` AND `Course.isActive=true`. Company는 status와 무관, 단 `isActive=true`여야 노출
- StudentEnrollmentRequest는 Teacher 또는 Assistant가 승인/거절 가능하며, 처리 시 `processedByMemberId` 기록
- 승인 시 자동 트랜잭션: `StudentCourseEnrollment`, `StudentCourseRecord`를 생성하고 `defaultClinicSlotId`가 있다면 향후 ClinicAttendance 배치에서 사용

### 2.3 주요 플로우

#### 2.3.1 Teacher/Assistant 승인 플로우
1. 학생이 공개 Course에 등록 신청 생성
2. 담당 Course의 Teacher 또는 매핑된 Assistant가 요청 목록 조회
3. 승인 시:
   - `StudentCourseEnrollment` insert (`enrolledAt=now`)
   - `StudentCourseRecord` insert (`defaultClinicSlotId` 초기값은 Teacher가 설정하거나 Null)
   - `StudentEnrollmentRequest.status=APPROVED`, `processedByMemberId`=승인자, `processedAt=now`
4. 거절 시 status=REJECTED, optional message

#### 2.3.2 클리닉 자동 배정 & 변경
1. 활성 ClinicSlot에 대해 매주 `ClinicSession`이 생성될 때, 해당 Slot을 `defaultClinicSlotId`로 가진 모든 StudentCourseRecord에 대해 같은 날짜의 `ClinicAttendance`가 자동 생성된다.
2. 학생은 세션 시작 전까지, 동일 주(월요일~일요일) 내에서는 횟수 제한 없이 참석 세션을 변경 가능하다.
   - 변경 시 기존 Attendance cancel → 새로운 Session에 Attendance 생성
   - 변경 이벤트는 `ClinicAttendance`의 `updatedBy`(감사 목적)로 기록하거나 별도 로그 optional
3. 세션 시작 시간 이후에는 변경 API가 409를 반환한다.

#### 2.3.3 학생 캘린더
- Teacher/Assistant는 `/students/{studentId}/calendar?year&month`를 호출해 SharedLesson + PersonalLesson + ClinicAttendance/ClinicRecord 데이터를 월 단위로 조회
- 학생은 `/students/me/calendar?year&month`를 호출해 자신의 동일 데이터를 조회하며, 승인된 Course 범위로 제한
- 응답 모델은 다음 섹션에서 정의

#### 2.3.4 조교 초대
1. Teacher는 `targetEmail`, 만료일, 메모(optional)를 지정해 Invitation 생성 (`maxUses` 항상 1)
2. 이메일 수신자는 `code`로 `/auth/verify-invitation` 호출 → `/auth/register/by-invitation`
3. 가입 시 자동으로 `ASSISTANT` role 부여 및 TeacherAssistantAssignment 생성

#### 2.3.5 INDIVIDUAL Company 검증 전략
- INDIVIDUAL Company는 생성 즉시 `status=VERIFIED`로 두어 검증 대기 시간을 줄이고, SuperAdmin이 필요 시 `status`를 변경 가능하도록 한다.
- ACADEMY는 SuperAdmin 검증 후 VERIFIED로 전환.

---

## 3. API 리소스 개요

| 리소스 | Base Path | 기능 요약 |
| --- | --- | --- |
| Auth | /auth | 로그인, 토큰, 역할별 회원가입, 초대 검증 |
| Members | /members | 내 정보 및 역할 필터 조회 |
| Companies | /companies | Company 등록/조회, SuperAdmin 검증 |
| Branches | /branches | Branch CRUD (OWNER만 생성/수정) |
| Courses | /courses, /public/courses | Course 관리 + 공개 검색 |
| StudentEnrollmentRequests | /student-enrollment-requests | 신청 생성/조회/승인/거절 |
| StudentCourses | /student-courses | Enrollment & Record 조회, teacherNotes 수정 |
| SharedLessons | /shared-lessons | 반 공통 진도 |
| PersonalLessons | /personal-lessons | 학생 개별 진도 |
| ClinicSlots | /clinic-slots | 슬롯 CRUD |
| ClinicSessions | /clinic-sessions | 세션 조회/취소/생성 |
| ClinicAttendances | /clinic-attendances | 출석 등록/조회/삭제, 학생 자율 변경 |
| ClinicRecords | /clinic-records | 출석 기록 CRUD |
| StudentCalendar | /students/{id}/calendar, /students/me/calendar | 월간 통합 캘린더 |
| Notices / NoticeReads | /notices, /notices/{id}/reads | 조교 공지 |
| WorkLogs | /work-logs | 조교 근무일지 |
| Invitations | /invitations | 조교 초대 |
| Feedback | /feedback | 사용자 피드백 |

---

## 4. 리소스 상세

### 4.1 Companies
| Method | URI | Description | Role |
| --- | --- | --- | --- |
| POST | /companies | Teacher가 Company 등록 (UNVERIFIED by default, INDIVIDUAL은 자동 VERIFIED) | TEACHER |
| GET | /companies | 검색 (필터: status, type, keyword) | TEACHER, ADMIN |
| PATCH | /companies/{companyId}/status | SuperAdmin이 status 변경 및 rejectionReason 작성 | SUPER_ADMIN |

### 4.2 Branches
| Method | URI | Description | Role |
| --- | --- | --- | --- |
| POST | /branches | OWNER 권한 Teacher가 Branch 생성 | TEACHER |
| GET | /branches?companyId | Branch 목록, 기본적으로 isActive=true만 반환 | TEACHER, ASSISTANT |
| PATCH | /branches/{branchId} | 이름 수정, isActive 토글 | OWNER Teacher |

### 4.3 Courses

- **공개 검색**: `GET /public/courses?keyword&companyId&branchId&teacherId&page`  
  - 필터 조건: `Course.isActive=true` AND `Branch.isActive=true` AND `Company.isActive=true`
  - 정렬: 최신 생성순, 이름순

| Method | URI | Description |
| --- | --- | --- |
| POST | /courses | Teacher가 Branch + 스케줄과 함께 생성, TeacherBranchAssignment 자동 생성 |
| GET | /courses | Teacher/Assistant 관점 반 목록 |
| GET | /courses/{courseId} | 상세 (학생 목록, 스케줄 포함) |
| PATCH | /courses/{courseId} | 정보 수정 |
| PATCH | /courses/{courseId}/deactivate | isActive=false |

### 4.4 StudentEnrollmentRequests

| Method | URI | Description | Role |
| --- | --- | --- | --- |
| POST | /student-enrollment-requests | 학생이 courseId + message로 신청 | STUDENT |
| GET | /student-enrollment-requests?courseId | Teacher/Assistant가 대기/과거 신청 조회 | TEACHER, ASSISTANT |
| PATCH | /student-enrollment-requests/{id}/approve | 승인 처리 → Enrollment/Record 자동 생성 | TEACHER, ASSISTANT |
| PATCH | /student-enrollment-requests/{id}/reject | 거절 처리 (message optional) | TEACHER, ASSISTANT |

승인/거절 응답에는 `processedByMemberId`, `processedAt` 포함.

### 4.5 StudentCourses & Records

| Method | URI | Description |
| --- | --- | --- |
| GET | /student-courses?courseId | 반별 학생 목록 (Enrollment + Record 조합) |
| PATCH | /student-courses/{recordId}/notes | Teacher가 `teacherNotes`, `defaultClinicSlotId` 수정 |
| GET | /students/me/courses | 학생 본인 승인된 Course 목록 |

`defaultClinicSlotId` 수정 시 이후 생성되는 ClinicSession부터 새로운 Slot으로 자동 배정된다.

### 4.6 ClinicSessions & Attendances

| Method | URI | Description |
| --- | --- | --- |
| GET | /clinic-sessions?dateRange&teacherId | 슬롯 기반 세션 조회 |
| POST | /clinic-slots/{slotId}/sessions | 단일 날짜 세션 수동 생성 |
| PATCH | /clinic-sessions/{sessionId}/cancel | isCanceled=true |

**학생 자율 변경 API**
| Method | URI | Description | Constraints |
| --- | --- | --- | --- |
| PATCH | /students/me/clinic-attendances | `{ "fromSessionId": UUID, "toSessionId": UUID }` | 두 세션은 동일 주, 동일 Course. 실행 시점이 fromSession 시작 전 |
| GET | /students/me/clinic-attendances?weekStart | 해당 주 자동/수동 배정 현황 조회 |  |

변경 성공 시 시스템은 기존 Attendance 삭제 후 신규 Attendance 생성하며, 변경 이력은 auditing 필드로 남긴다.

### 4.7 Student Calendar

- **Teacher/Assistant View**: `GET /students/{studentId}/calendar?year&month`
- **Student View**: `GET /students/me/calendar?year&month`

Response (`StudentCalendarResponse`):
```jsonc
{
  "studentId": "uuid",
  "year": 2025,
  "month": 3,
  "sharedLessons": [
    { "id": "uuid", "courseId": "uuid", "date": "2025-03-02", "title": "..." }
  ],
  "personalLessons": [
    { "id": "uuid", "studentCourseRecordId": "uuid", "date": "2025-03-03", "title": "...", "writerRole": "TEACHER" }
  ],
  "clinicEvents": [
    {
      "clinicSessionId": "uuid",
      "date": "2025-03-04",
      "startTime": "18:00",
      "endTime": "19:00",
      "attendanceStatus": "SCHEDULED|CANCELED|MISSED",
      "recordId": "uuid?", 
      "recordTitle": "string?"
    }
  ]
}
```
`clinicEvents`는 Attendance + Record를 합쳐 상태를 제공한다.

### 4.8 Invitations

| Method | URI | Description |
| --- | --- | --- |
| POST | /invitations | `targetEmail`, `expiredAt`, `message` 입력. `maxUses` 고정 1 |
| GET | /invitations | Teacher 자신의 초대 목록 |
| GET | /invitations/code/{code} | 회원가입 전에 상세 조회 |
| DELETE | /invitations/{id} | 초대 취소 |
| POST | /auth/verify-invitation | code 검증 |
| POST | /auth/register/by-invitation | 초대 기반 조교 가입 |

사용 시 `useCount` = 1 → status=ACCEPTED로 변경되어 재사용 불가.

### 4.9 Notices, WorkLogs, Feedback
- v1.2와 동일한 CRUD, 단 Notice/WorkLog는 Teacher ↔ Assistant 관계를 기준으로 접근 제어

---

## 5. 비기능 및 통합

- JWT 기반 인증/인가, 역할: TEACHER / ASSISTANT / STUDENT / SUPER_ADMIN
- SuperAdmin은 Company status와 Feedback 해소 전담
- 자동화:
  - Weekly ClinicSession/Attendance 생성 배치 (일요일 밤 실행)
  - 학생 자율 변경은 동기 REST API, 성공 시 캐시/캘린더 invalidate
  - StudentCalendarQueryService는 Lesson/Clinic 데이터를 Redis 캐싱 (month key)하여 Teacher/Assistant 조회시 1s 이하 응답 목표

---

## 6. 추적성

- Requirement v1.3 → Spec v1.3: FR-01 (조직 관리), FR-02 (학생 등록), FR-03 (클리닉), FR-04 (조교 협업), FR-05 (학생 캘린더)
- 향후 TODO/PLAN 문서는 이 스펙 버전을 참조해야 하며, StudentCalendar/Clinic 변경과 같이 교차 도메인 작업 시 관련 PLAN을 분리한다.
